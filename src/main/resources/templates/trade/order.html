<!doctype html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
    <head>
        <title>거래소</title>
        <style>
            td {font-size: 11px;}
            tr {font-size: 10px;}
        </style>
    </head>
    <body layout:fragment="content">
        <div class="container mt-3">
            <div class="d-flex">
                <section>
                    <div class="me-4">
                        <div class="d-flex">
                            <span class="me-2"><h2 th:text="${upbitCryptoInfo.koreanName}">암호화폐 이름</h2></span>
                            <span th:text="${upbitCryptoInfo.market}" class="align-self-center"></span>
                        </div>
                        <!-- chart widget -->
                        <div id="trading_chart_view"></div>
                    </div>
                </section>

                <section style="height: 500px">
                    <!-- Tabs navs -->
                    <ul class="nav nav-tabs nav-justified" id="ex1" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a
                                    class="nav-link active"
                                    id="ex3-tab-1"
                                    data-mdb-toggle="tab"
                                    href="#ex3-tabs-1"
                                    role="tab"
                                    aria-controls="ex3-tabs-1"
                                    aria-selected="true"
                            >원화</a
                            >
                        </li>
                        <li class="nav-item" role="presentation">
                            <a
                                    class="nav-link"
                                    id="ex3-tab-2"
                                    data-mdb-toggle="tab"
                                    href="#ex3-tabs-2"
                                    role="tab"
                                    aria-controls="ex3-tabs-2"
                                    aria-selected="false"
                            >보유</a
                            >
                        </li>
                        <li class="nav-item" role="presentation">
                            <a
                                    class="nav-link"
                                    id="ex3-tab-3"
                                    data-mdb-toggle="tab"
                                    href="#ex3-tabs-3"
                                    role="tab"
                                    aria-controls="ex3-tabs-3"
                                    aria-selected="false"
                            >관심</a
                            >
                        </li>
                    </ul>
                    <!-- Tabs navs -->

                    <!-- Tabs content -->
                    <div class="tab-content border" id="ex2-content"  style="width: 420px; height: 540px; overflow: auto">
                        <div class="tab-pane fade show active" id="ex3-tabs-1" role="tabpanel" aria-labelledby="ex3-tab-1">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">한글명</th>
                                        <th scope="col">현재가</th>
                                        <th scope="col">전일대비</th>
                                        <th scope="col">거래대금</th>
                                    </tr>
                                </thead>
                                <tbody>
                                <th:block th:each="item : ${upbitMarketList}">
                                    <tr th:onclick="|location.href='@{/trade/order(code=${item.market})}'|">
                                        <td style="font-weight: bold" th:text="${item.koreanName}">-</td>
                                        <td style="font-weight: bold" th:id="${item.market} + '-trade_price'" class="text-align-table-right">-</td>
                                        <td th:id="${item.market} + '-signed_change_rate'" class="text-align-table-right">-</td>
                                        <td th:id="${item.market} + '-acc_trade_price_24h'" class="text-align-table-right">-</td>
                                    </tr>
                                </th:block>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="ex3-tabs-2" role="tabpanel" aria-labelledby="ex3-tab-2">
                            Tab 2 content
                        </div>

                        <div class="tab-pane fade" id="ex3-tabs-3" role="tabpanel" aria-labelledby="ex3-tab-3">
                            Tab 3 content
                        </div>
                    </div>
                    <!-- Tabs content -->
                </section>
            </div>

            <!-- TradingView Widget BEGIN -->
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
                // 암호화폐 symbol 위젯 불러오기
                const urlParams = new URL(location.href).searchParams;
                let pure_market_code = "";

                if (urlParams.size < 1) { // 쿼리 스트링 없을 때 기본 비트코인으로 보여준다
                    pure_market_code = "BTC";
                } else {
                    const market_code = urlParams.get('code');
                    pure_market_code = market_code.split('-')[1];
                }

                new TradingView.widget(
                    {
                        "width": 900,
                        "height": 540,
                        // autosize: true,
                        custom_font_family: "'Noto Sans KR', sans-serif",
                        symbol: "UPBIT:" + pure_market_code + "KRW",
                        interval: "D",
                        timezone: "Asia/Seoul",
                        theme: "light",
                        style: "1",
                        locale: "kr",
                        enable_publishing: true,
                        allow_symbol_change: false,
                        container_id: "trading_chart_view",
                    }
                );
            </script>
        </div>
        <!-- TradingView Widget END -->

        <!-- Upbit Websocket -->
        <script type="text/javascript" th:inline="javascript">

            // 웹소켓 생성
            const upbitWebsocketUrl = "wss://api.upbit.com/websocket/v1";
            const socket = new WebSocket(upbitWebsocketUrl);

            // 커넥션이 제대로 생성되었을 때
            socket.onopen = function (e) {
                console.log("웹 소켓 연결 성공")
                let jsonData = [
                    {
                        "ticket": "test example"
                    },
                    {
                        "type": "ticker",
                        "codes": [[${marketListString}]] // ["KRW-BTC", "KRW-NEO" ... ]
                    }
                ];

                socket.send(JSON.stringify(jsonData))
            };

            // 데이터를 수신 받았을 때
            socket.onmessage = async function (e) {
                try {
                    if (e !== null && e !== undefined) {
                        let result = JSON.parse(await e.data.text()); // blob to json
                        // console.log(result);

                        // 암호화폐 마켓 코드
                        let crypto_code = result.code; // ex) KRW-BTC, KRW-NEO ...

                        // 현재가
                        let trade_price = result.trade_price;
                        trade_price = new Intl.NumberFormat('ko-kr').format(trade_price);

                        // 전일 대비 등락율(%)
                        let signed_change_rate = (result.signed_change_rate * 100 ).toFixed(2);

                        if (signed_change_rate > 0) { // 전일 대비 상승일 경우 style
                            signed_change_rate = "+" + signed_change_rate; // 부호 + 붙여주기
                            document.getElementById(crypto_code + '-trade_price').style.color = '#0ea600';
                            document.getElementById(crypto_code + '-signed_change_rate').style.color = '#0ea600';
                        } else if (signed_change_rate == 0) { //  전일 대비 같을 경우
                            document.getElementById(crypto_code + '-trade_price').style.color = 'gray';
                            document.getElementById(crypto_code + '-signed_change_rate').style.color = 'gray';
                        } else if (signed_change_rate < 0) { // 전일 대비 하락인 경우
                            document.getElementById(crypto_code + '-trade_price').style.color = '#F6465D';
                            document.getElementById(crypto_code + '-signed_change_rate').style.color = '#F6465D';
                        }

                        // 24시간 누적 거래대금
                        let acc_trade_price_24h = Math.ceil(result.acc_trade_price_24h);
                        acc_trade_price_24h = Math.round(acc_trade_price_24h / 1000000) * 1000000;
                        acc_trade_price_24h = acc_trade_price_24h.toString();
                        acc_trade_price_24h = acc_trade_price_24h.slice(0, acc_trade_price_24h.length-6) + "백만";

                        // 해당하는 암호화폐 html text 변경해준다
                        document.getElementById(crypto_code + '-trade_price').innerText = trade_price;
                        document.getElementById(crypto_code + '-signed_change_rate').innerText = signed_change_rate + "%";
                        document.getElementById(crypto_code + '-acc_trade_price_24h').innerText = acc_trade_price_24h;
                        // console.log(crypto_code + "현재가 : " + trade_price, "전일 대비 등락율" + signed_change_rate, "24시간 누적 거래대금 : " + acc_trade_price_24h);
                    }
                } catch (err) {
                    console.log("ERROR !!" + err);
                }
            };

            // 에러가 발생했을 때
            socket.onerror = function (e) {
                console.log("업비트 웹소켓 연결 실패");
                console.log(e);
            };
        </script>

    </body>

</html>